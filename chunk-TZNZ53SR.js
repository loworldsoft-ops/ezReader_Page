import{b as p}from"./chunk-ZO574LIR.js";import{a as T}from"./chunk-JAFV3UXJ.js";import{$ as l,da as y,g as h}from"./chunk-2NYEL3ZQ.js";import{h as K,j as i}from"./chunk-TWZW5B45.js";var n=K(T());var d=class A{constructor(e){this.indexedDbService=e;try{let t=n.AES.decrypt(this.ENCRYPTED_FALLBACK_KEY,this.ENCRYPTION_KEY);this.FALLBACK_API_KEY=t.toString(n.enc.Utf8)}catch{this.FALLBACK_API_KEY=""}try{let t=n.AES.decrypt(this.ENCRYPTED_BACKUP_KEY,this.ENCRYPTION_KEY);this.BACKUP_API_KEY=t.toString(n.enc.Utf8)}catch{this.BACKUP_API_KEY=""}try{let t=n.AES.decrypt(this.ENCRYPTED_BACKUP_KEY_2,this.ENCRYPTION_KEY);this.BACKUP_API_KEY_2=t.toString(n.enc.Utf8)}catch{this.BACKUP_API_KEY_2=""}this.initPromise=this.initialize()}OAUTH_TOKEN_STORAGE_KEY="ezm_google_oauth_token";TEST_API_KEY_STORAGE_KEY="ezm_test_gemini_api_key";ENCRYPTION_KEY="ezReaderMobile";ENCRYPTED_FALLBACK_KEY="U2FsdGVkX184mAiYUKguR4G/nD84XUV6Caf1fLhjU5FOKmxzcx14BuFF0RZRi5Hxy2wgI+3G9ea+Q3cwTYzhtA==";ENCRYPTED_BACKUP_KEY="U2FsdGVkX1/W1Sve3PLqMLC6F1ajC3WrqeVeOHj1MOI+jdi9gQUvYG0aMWrLMEJTEvXoM9pdinXPQzeU9qB7Sg==";ENCRYPTED_BACKUP_KEY_2="U2FsdGVkX19Qef6Mc3hz37nfxwf12Wlb8J8WPSpykai9xA470yvXMVu0fWyX4bwSMVil9GoQhST7Kvi7niH5Ag==";FALLBACK_API_KEY;BACKUP_API_KEY;BACKUP_API_KEY_2;currentKeyType="fallback";KEY_TYPE_STORAGE="ezm_gemini_current_key_type";useOAuthForAI=!1;OAUTH_MODE_STORAGE="ezm_use_oauth_for_ai";oauthTokenSubject=new h(null);oauthToken$=this.oauthTokenSubject.asObservable();testApiKeySubject=new h(null);testApiKey$=this.testApiKeySubject.asObservable();apiKeySubject=new h(null);apiKey$=this.apiKeySubject.asObservable();initialized=!1;initPromise=null;initialize(){return i(this,null,function*(){if(!this.initialized)try{yield this.loadOAuthMode(),yield this.loadOAuthToken(),yield this.loadTestApiKey(),yield this.loadCurrentKeyType(),this.updateApiKeySubject(),this.initialized=!0,console.log("\u2705 GeminiApiManager \uCD08\uAE30\uD654 \uC644\uB8CC"),console.log("\u{1F4CA} OAuth \uBAA8\uB4DC:",this.useOAuthForAI?"ON":"OFF"),console.log("\u{1F4CA} OAuth \uD1A0\uD070:",this.oauthTokenSubject.value?"\uC788\uC74C":"\uC5C6\uC74C"),console.log("\u{1F4CA} \uD14C\uC2A4\uD2B8 API \uD0A4:",this.testApiKeySubject.value?"\uC788\uC74C":"\uC5C6\uC74C")}catch(e){console.error("\u274C GeminiApiManager \uCD08\uAE30\uD654 \uC2E4\uD328:",e),this.initialized=!0}})}ensureInitialized(){return i(this,null,function*(){this.initPromise&&(yield this.initPromise)})}setOAuthToken(e,t,s){return i(this,null,function*(){yield this.ensureInitialized();try{let r={apiKey:e,userId:t,email:s,isOAuthToken:!0,expiresAt:new Date(Date.now()+36e5)},o=n.AES.encrypt(JSON.stringify(r),this.ENCRYPTION_KEY).toString();yield this.saveToIndexedDB(this.OAUTH_TOKEN_STORAGE_KEY,o),this.oauthTokenSubject.next(e),this.useOAuthForAI?this.apiKeySubject.next(e):(console.log("\u{1F504} OAuth \uD1A0\uD070 \uC800\uC7A5\uB428 \u2192 OAuth \uBAA8\uB4DC \uC790\uB3D9 \uD65C\uC131\uD654"),yield this.setOAuthMode(!0)),console.log("\u2705 OAuth \uD1A0\uD070 \uC800\uC7A5 \uC644\uB8CC (OAuth \uBAA8\uB4DC: ON)")}catch(r){throw console.error("\u274C OAuth \uD1A0\uD070 \uC800\uC7A5 \uC2E4\uD328:",r),r}})}setTestApiKey(e,t,s){return i(this,null,function*(){yield this.ensureInitialized();try{let r={apiKey:e,userId:t,email:s,isOAuthToken:!1,expiresAt:new Date(Date.now()+2592e6)},o=n.AES.encrypt(JSON.stringify(r),this.ENCRYPTION_KEY).toString();yield this.saveToIndexedDB(this.TEST_API_KEY_STORAGE_KEY,o),this.testApiKeySubject.next(e),this.useOAuthForAI||this.apiKeySubject.next(e),console.log("\u2705 Gemini API \uD0A4 \uC800\uC7A5 \uC644\uB8CC")}catch(r){throw console.error("\u274C Gemini API \uD0A4 \uC800\uC7A5 \uC2E4\uD328:",r),r}})}setApiKey(e,t,s,r=!1){return i(this,null,function*(){yield this.ensureInitialized();try{let o;if(r){if(o=n.AES.decrypt(e,this.ENCRYPTION_KEY).toString(n.enc.Utf8),!o)throw new Error("API \uD0A4 \uBCF5\uD638\uD654 \uC2E4\uD328")}else o=e;this.isOAuthToken(o)?yield this.setOAuthToken(o,t,s):yield this.setTestApiKey(o,t,s)}catch(o){throw o}})}loadOAuthToken(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.OAUTH_TOKEN_STORAGE_KEY);if(!e)return;let s=n.AES.decrypt(e,this.ENCRYPTION_KEY).toString(n.enc.Utf8);if(!s){yield this.clearOAuthToken();return}let r=JSON.parse(s);if(r.expiresAt&&new Date(r.expiresAt)<new Date){console.warn("\u26A0\uFE0F OAuth \uD1A0\uD070\uC774 \uB9CC\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),yield this.clearOAuthToken();return}this.oauthTokenSubject.next(r.apiKey)}catch(e){console.error("OAuth \uD1A0\uD070 \uB85C\uB4DC \uC2E4\uD328:",e),yield this.clearOAuthToken()}})}loadTestApiKey(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.TEST_API_KEY_STORAGE_KEY);if(!e)return;let s=n.AES.decrypt(e,this.ENCRYPTION_KEY).toString(n.enc.Utf8);if(!s){yield this.clearTestApiKey();return}let r=JSON.parse(s);if(r.expiresAt&&new Date(r.expiresAt)<new Date){console.warn("\u26A0\uFE0F \uD14C\uC2A4\uD2B8 Gemini API \uD0A4\uAC00 \uB9CC\uB8CC\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),yield this.clearTestApiKey();return}this.testApiKeySubject.next(r.apiKey)}catch(e){console.error("\uD14C\uC2A4\uD2B8 API \uD0A4 \uB85C\uB4DC \uC2E4\uD328:",e),yield this.clearTestApiKey()}})}getApiKey(){if(this.useOAuthForAI){let t=this.oauthTokenSubject.value;if(t)return t;console.warn("\u26A0\uFE0F OAuth \uBAA8\uB4DC\uC774\uC9C0\uB9CC \uD1A0\uD070\uC774 \uC5C6\uC2B5\uB2C8\uB2E4. \uD14C\uC2A4\uD2B8 Gemini API \uD0A4 \uC0AC\uC6A9")}let e=this.testApiKeySubject.value;return e||(console.warn("\u26A0\uFE0F \uC0AC\uC6A9\uC790 \uD0A4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4. Fallback \uD0A4 \uC0AC\uC6A9"),this.getFallbackKey())}getFallbackKey(){switch(this.currentKeyType){case"backup":return this.BACKUP_API_KEY||this.FALLBACK_API_KEY;case"backup2":return this.BACKUP_API_KEY_2||this.BACKUP_API_KEY||this.FALLBACK_API_KEY;case"user":case"fallback":default:return this.FALLBACK_API_KEY}}isOAuthToken(e){return e?e.startsWith("ya29.")||e.length>100&&!e.startsWith("AIza"):!1}switchToBackupKey(){return i(this,null,function*(){switch(this.currentKeyType){case"fallback":return this.BACKUP_API_KEY?(this.currentKeyType="backup",yield this.saveCurrentKeyType(),console.log("\u2705 \uBC31\uC5C5 API \uD0A4 1\uB85C \uC804\uD658\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),!0):(console.error("\uBC31\uC5C5 API \uD0A4 1\uC774 \uC5C6\uC2B5\uB2C8\uB2E4."),!1);case"backup":return this.BACKUP_API_KEY_2?(this.currentKeyType="backup2",yield this.saveCurrentKeyType(),console.log("\u2705 \uBC31\uC5C5 API \uD0A4 2\uB85C \uC804\uD658\uB418\uC5C8\uC2B5\uB2C8\uB2E4."),!0):(console.error("\uBC31\uC5C5 API \uD0A4 2\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),!1);case"backup2":case"user":default:return console.warn("\u26A0\uFE0F \uB354 \uC774\uC0C1 \uC0AC\uC6A9 \uAC00\uB2A5\uD55C \uBC31\uC5C5 \uD0A4\uAC00 \uC5C6\uC2B5\uB2C8\uB2E4."),!1}})}resetToFallbackKey(){return i(this,null,function*(){this.currentKeyType="fallback",yield this.saveCurrentKeyType(),console.log("\u2705 \uAE30\uBCF8 API \uD0A4\uB85C \uB9AC\uC14B\uB418\uC5C8\uC2B5\uB2C8\uB2E4.")})}getCurrentKeyType(){return this.currentKeyType}saveCurrentKeyType(){return i(this,null,function*(){try{yield this.saveToIndexedDB(this.KEY_TYPE_STORAGE,this.currentKeyType)}catch(e){console.error("\uD0A4 \uD0C0\uC785 \uC800\uC7A5 \uC2E4\uD328:",e)}})}loadCurrentKeyType(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.KEY_TYPE_STORAGE);e&&["fallback","backup","backup2","user"].includes(e)&&(this.currentKeyType=e)}catch{this.currentKeyType="fallback"}})}setOAuthMode(e){return i(this,null,function*(){this.useOAuthForAI=e,yield this.saveToIndexedDB(this.OAUTH_MODE_STORAGE,e.toString()),this.updateApiKeySubject(),console.log(`\u2705 OAuth AI \uD638\uCD9C \uBAA8\uB4DC: ${e?"ON":"OFF"}`)})}getOAuthMode(){return this.useOAuthForAI}updateApiKeySubject(){this.useOAuthForAI?this.apiKeySubject.next(this.oauthTokenSubject.value):this.apiKeySubject.next(this.testApiKeySubject.value)}loadOAuthMode(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.OAUTH_MODE_STORAGE);this.useOAuthForAI=e==="true"}catch{this.useOAuthForAI=!1}})}getAuthenticationStatus(){return i(this,null,function*(){yield this.ensureInitialized();let e=yield this.getOAuthTokenInfo(),t=yield this.getTestApiKeyInfo();return{hasOAuthToken:!!e&&!!e.apiKey,hasTestApiKey:!!t&&!!t.apiKey,oauthTokenInfo:e,testApiKeyInfo:t,currentMode:this.useOAuthForAI?"oauth":"test-api-key"}})}getOAuthTokenInfo(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.OAUTH_TOKEN_STORAGE_KEY);if(!e)return null;let s=n.AES.decrypt(e,this.ENCRYPTION_KEY).toString(n.enc.Utf8);return s?JSON.parse(s):null}catch{return null}})}getTestApiKeyInfo(){return i(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.TEST_API_KEY_STORAGE_KEY);if(!e)return null;let s=n.AES.decrypt(e,this.ENCRYPTION_KEY).toString(n.enc.Utf8);return s?JSON.parse(s):null}catch{return null}})}getApiKeyInfo(){return i(this,null,function*(){if(yield this.ensureInitialized(),this.useOAuthForAI){let e=yield this.getOAuthTokenInfo();if(e)return e}return yield this.getTestApiKeyInfo()})}clearOAuthToken(){return i(this,null,function*(){try{yield this.deleteFromIndexedDB(this.OAUTH_TOKEN_STORAGE_KEY),this.oauthTokenSubject.next(null),this.hasTestApiKey()&&this.useOAuthForAI&&(console.log("\u{1F504} OAuth \uD1A0\uD070 \uC0AD\uC81C\uB428 \u2192 API \uD0A4 \uBAA8\uB4DC\uB85C \uC790\uB3D9 \uC804\uD658"),yield this.setOAuthMode(!1)),console.log("\u2705 OAuth \uD1A0\uD070 \uC0AD\uC81C \uC644\uB8CC")}catch(e){throw console.error("\u274C OAuth \uD1A0\uD070 \uC0AD\uC81C \uC2E4\uD328:",e),e}})}clearTestApiKey(){return i(this,null,function*(){try{yield this.deleteFromIndexedDB(this.TEST_API_KEY_STORAGE_KEY),this.testApiKeySubject.next(null),console.log("\u2705 \uD14C\uC2A4\uD2B8 Gemini API \uD0A4 \uC0AD\uC81C \uC644\uB8CC")}catch(e){throw console.error("\u274C \uD14C\uC2A4\uD2B8 Gemini API \uD0A4 \uC0AD\uC81C \uC2E4\uD328:",e),e}})}clearAllAuthentication(){return i(this,null,function*(){yield this.clearOAuthToken(),yield this.clearTestApiKey()})}clearApiKey(){return i(this,null,function*(){yield this.clearAllAuthentication()})}hasOAuthToken(){return!!this.oauthTokenSubject.value}hasTestApiKey(){return!!this.testApiKeySubject.value}hasApiKey(){return this.hasOAuthToken()||this.hasTestApiKey()}saveToIndexedDB(e,t){return i(this,null,function*(){let o=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((c,a)=>{let u=o.put({key:e,value:t});u.onsuccess=()=>c(),u.onerror=()=>a(u.error)})})}getFromIndexedDB(e){return i(this,null,function*(){let r=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readonly").objectStore("settings");return new Promise((o,c)=>{let a=r.get(e);a.onsuccess=()=>{let u=a.result;o(u?u.value:null)},a.onerror=()=>c(a.error)})})}deleteFromIndexedDB(e){return i(this,null,function*(){let r=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((o,c)=>{let a=r.delete(e);a.onsuccess=()=>o(),a.onerror=()=>c(a.error)})})}static \u0275fac=function(t){return new(t||A)(y(p))};static \u0275prov=l({token:A,factory:A.\u0275fac,providedIn:"root"})};export{d as a};
