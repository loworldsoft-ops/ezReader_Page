import{b as S}from"./chunk-ZO574LIR.js";import{a as b}from"./chunk-JAFV3UXJ.js";import{$ as l,da as u,g as y}from"./chunk-2NYEL3ZQ.js";import{h,j as a}from"./chunk-TWZW5B45.js";var s=h(b());var K=class p{constructor(e){this.indexedDbService=e;this.loadStoredApiKey()}STORAGE_KEY="ez_gemini_api_key";ENCRYPTION_KEY="ezReader2024";apiKeySubject=new y(null);apiKey$=this.apiKeySubject.asObservable();setApiKey(e,o,i,n=!1){return a(this,null,function*(){try{let t;if(n){if(t=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8),!t)throw new Error("API \uD0A4 \uBCF5\uD638\uD654 \uC2E4\uD328")}else t=e;let c={apiKey:t,userId:o,email:i,expiresAt:new Date(Date.now()+720*60*60*1e3)},r=s.AES.encrypt(JSON.stringify(c),this.ENCRYPTION_KEY).toString();yield this.saveToIndexedDB(this.STORAGE_KEY,r),this.apiKeySubject.next(t)}catch(t){throw console.error("\u274C API \uD0A4 \uC124\uC815 \uC2E4\uD328:",t),t}})}loadStoredApiKey(){return a(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.STORAGE_KEY);if(!e)return;let i=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8);if(!i){yield this.clearApiKey();return}let n=JSON.parse(i);if(n.expiresAt&&new Date(n.expiresAt)<new Date){yield this.clearApiKey();return}this.apiKeySubject.next(n.apiKey)}catch(e){console.error("\u274C API \uD0A4 \uB85C\uB4DC \uC2E4\uD328:",e),yield this.clearApiKey()}})}getApiKey(){return this.apiKeySubject.value}getApiKeyInfo(){return a(this,null,function*(){try{let e=yield this.getFromIndexedDB(this.STORAGE_KEY);if(!e)return null;let i=s.AES.decrypt(e,this.ENCRYPTION_KEY).toString(s.enc.Utf8);return i?JSON.parse(i):null}catch(e){return console.error("\u274C API \uD0A4 \uC815\uBCF4 \uC870\uD68C \uC2E4\uD328:",e),null}})}clearApiKey(){return a(this,null,function*(){try{yield this.deleteFromIndexedDB(this.STORAGE_KEY),this.apiKeySubject.next(null)}catch(e){throw console.error("\u274C API \uD0A4 \uC0AD\uC81C \uC2E4\uD328:",e),e}})}hasApiKey(){return!!this.apiKeySubject.value}saveToIndexedDB(e,o){return a(this,null,function*(){let t=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((c,r)=>{let d=t.put({key:e,value:o});d.onsuccess=()=>c(),d.onerror=()=>r(d.error)})})}getFromIndexedDB(e){return a(this,null,function*(){let n=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readonly").objectStore("settings");return new Promise((t,c)=>{let r=n.get(e);r.onsuccess=()=>{let d=r.result;t(d?d.value:null)},r.onerror=()=>c(r.error)})})}deleteFromIndexedDB(e){return a(this,null,function*(){let n=(yield this.indexedDbService.ensureDB()).transaction(["settings"],"readwrite").objectStore("settings");return new Promise((t,c)=>{let r=n.delete(e);r.onsuccess=()=>t(),r.onerror=()=>c(r.error)})})}static \u0275fac=function(o){return new(o||p)(u(S))};static \u0275prov=l({token:p,factory:p.\u0275fac,providedIn:"root"})};export{K as a};
