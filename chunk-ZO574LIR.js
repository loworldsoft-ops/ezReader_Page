import{e as v}from"./chunk-JAFV3UXJ.js";import{$ as f,ea as C}from"./chunk-2NYEL3ZQ.js";import{a as w,b as S,j as u}from"./chunk-TWZW5B45.js";var p=class b{debugLogger=C(v);db=null;dbReady;constructor(){this.dbReady=Promise.resolve()}initDB(){return u(this,null,function*(){return new Promise((e,t)=>{this.debugLogger.info(this.logCategory,`\u{1F527} ${this.dbName} \uCD08\uAE30\uD654 \uC2DC\uC791...`);let s=indexedDB.open(this.dbName,this.version);s.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C DB \uC5F4\uAE30 \uC2E4\uD328: ${s.error}`),this.db=null,t(s.error)},s.onsuccess=()=>{this.db=s.result,this.db.onclose=()=>{this.debugLogger.warn(this.logCategory,"\u26A0\uFE0F DB \uC5F0\uACB0\uC774 \uB2EB\uD798"),this.db=null},this.db.onerror=g=>{this.debugLogger.error(this.logCategory,`\u274C DB \uC624\uB958: ${g}`)},this.debugLogger.success(this.logCategory,`\u2705 ${this.dbName} \uCD08\uAE30\uD654 \uC131\uACF5`),e()},s.onupgradeneeded=g=>{this.debugLogger.info(this.logCategory,`\u2B06\uFE0F ${this.dbName} \uC5C5\uADF8\uB808\uC774\uB4DC \uC911...`);let c=g.target.result,a=g.target.transaction;this.createObjectStore(c,a),this.debugLogger.success(this.logCategory,`\u2705 ${this.dbName} \uC5C5\uADF8\uB808\uC774\uB4DC \uC644\uB8CC`)}})})}ensureDB(){return u(this,null,function*(){if(yield this.dbReady,this.db&&!this.db.objectStoreNames.length&&(this.db=null),this.db||(yield this.initDB()),!this.db)throw new Error(`${this.dbName} \uC5F0\uACB0 \uC2E4\uD328`);return this.db})}transaction(e,t){return u(this,null,function*(){let s=yield this.ensureDB();return new Promise((g,c)=>{let a=s.transaction([this.storeName],e),n=a.objectStore(this.storeName),r=t(n);r.onsuccess=()=>{g(r.result)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD2B8\uB79C\uC7AD\uC158 \uC624\uB958: ${r.error}`),c(r.error)},a.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD2B8\uB79C\uC7AD\uC158 \uC2E4\uD328: ${a.error}`),c(a.error)}})})}save(e){return u(this,null,function*(){try{yield this.transaction("readwrite",t=>t.put(e)),this.debugLogger.success(this.logCategory,"\u{1F4BE} \uB370\uC774\uD130 \uC800\uC7A5 \uC644\uB8CC")}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uC800\uC7A5 \uC2E4\uD328: ${t}`),t}})}getById(e){return u(this,null,function*(){try{return(yield this.transaction("readonly",s=>s.get(e)))||null}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${t}`),null}})}getAll(){return u(this,null,function*(){try{let e=yield this.transaction("readonly",t=>t.getAll());return this.debugLogger.info(this.logCategory,`\u{1F4CB} \uB370\uC774\uD130 \uBAA9\uB85D \uC870\uD68C \uC644\uB8CC: ${e.length}\uAC1C`),e}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uBAA9\uB85D \uC870\uD68C \uC2E4\uD328: ${e}`),[]}})}delete(e){return u(this,null,function*(){try{yield this.transaction("readwrite",t=>t.delete(e)),this.debugLogger.success(this.logCategory,`\u{1F5D1}\uFE0F \uB370\uC774\uD130 \uC0AD\uC81C \uC644\uB8CC: ${e}`)}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uC0AD\uC81C \uC2E4\uD328: ${t}`),t}})}clear(){return u(this,null,function*(){try{yield this.transaction("readwrite",e=>e.clear()),this.debugLogger.success(this.logCategory,"\u{1F9F9} \uBAA8\uB4E0 \uB370\uC774\uD130 \uC0AD\uC81C \uC644\uB8CC")}catch(e){throw this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uC0AD\uC81C \uC2E4\uD328: ${e}`),e}})}count(){return u(this,null,function*(){try{return yield this.transaction("readonly",t=>t.count())}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130 \uAC1C\uC218 \uC870\uD68C \uC2E4\uD328: ${e}`),0}})}getByIndex(e,t){return u(this,null,function*(){try{let s=yield this.ensureDB();return new Promise((g,c)=>{let o=s.transaction([this.storeName],"readonly").objectStore(this.storeName).index(e).getAll(t);o.onsuccess=()=>{g(o.result)},o.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uC778\uB371\uC2A4 \uC870\uD68C \uC2E4\uD328: ${o.error}`),c(o.error)}})}catch(s){return this.debugLogger.error(this.logCategory,`\u274C \uC778\uB371\uC2A4 \uC870\uD68C \uC911 \uC624\uB958: ${s}`),[]}})}forEach(e,t="next"){return u(this,null,function*(){try{let s=yield this.ensureDB();return new Promise((g,c)=>{let r=s.transaction([this.storeName],"readonly").objectStore(this.storeName).openCursor(null,t);r.onsuccess=()=>u(this,null,function*(){let o=r.result;o?(yield e(o.value),o.continue()):g()}),r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uCEE4\uC11C \uC21C\uD68C \uC2E4\uD328: ${r.error}`),c(r.error)}})}catch(s){throw this.debugLogger.error(this.logCategory,`\u274C \uCEE4\uC11C \uC21C\uD68C \uC911 \uC624\uB958: ${s}`),s}})}closeConnection(){this.db&&(this.db.close(),this.db=null,this.debugLogger.info(this.logCategory,`\u{1F50C} ${this.dbName} \uC5F0\uACB0 \uC885\uB8CC`))}resetDatabase(){return u(this,null,function*(){return new Promise((e,t)=>{this.closeConnection();let s=indexedDB.deleteDatabase(this.dbName);s.onsuccess=()=>{this.debugLogger.success(this.logCategory,`\u2705 ${this.dbName} \uC0AD\uC81C \uC644\uB8CC`),this.dbReady=this.initDB(),this.dbReady.then(()=>{this.debugLogger.success(this.logCategory,`\u2705 ${this.dbName} \uC7AC\uC0DD\uC131 \uC644\uB8CC`),e()}).catch(t)},s.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C ${this.dbName} \uC0AD\uC81C \uC2E4\uD328: ${s.error}`),t(s.error)},s.onblocked=()=>{this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F ${this.dbName} \uC0AD\uC81C\uAC00 \uCC28\uB2E8\uB428 - \uB2E4\uB978 \uD0ED\uC5D0\uC11C \uC0AC\uC6A9 \uC911\uC77C \uC218 \uC788\uC2B5\uB2C8\uB2E4.`)}})})}static \u0275fac=function(t){return new(t||b)};static \u0275prov=f({token:b,factory:b.\u0275fac})};var I=class b extends p{dbName="EzReaderDB";storeName="documents";version=6;logCategory="IndexedDB-Document";constructor(){super(),this.dbReady=this.initDB()}createObjectStore(e,t){if(e.objectStoreNames.contains("documents")){if(t){let s=t.objectStore("documents");s&&!s.indexNames.contains("folderId")&&(s.createIndex("folderId","folderId",{unique:!1}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} documents \uC800\uC7A5\uC18C\uC5D0 folderId \uC778\uB371\uC2A4 \uCD94\uAC00\uB428"))}}else{let s=e.createObjectStore("documents",{keyPath:"id"});s.createIndex("title","title",{unique:!1}),s.createIndex("createdAt","createdAt",{unique:!1}),s.createIndex("updatedAt","updatedAt",{unique:!1}),s.createIndex("folderId","folderId",{unique:!1}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} documents \uC800\uC7A5\uC18C \uC0DD\uC131\uB428")}if(!e.objectStoreNames.contains("documentsMeta")){let s=e.createObjectStore("documentsMeta",{keyPath:"id"});s.createIndex("folderId","folderId",{unique:!1}),s.createIndex("updatedAt","updatedAt",{unique:!1}),s.createIndex("isFavorite","isFavorite",{unique:!1}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} documentsMeta \uC800\uC7A5\uC18C \uC0DD\uC131\uB428 (\uBAA9\uB85D \uC870\uD68C \uCD5C\uC801\uD654)")}if(!e.objectStoreNames.contains("folders")){let s=e.createObjectStore("folders",{keyPath:"id"});s.createIndex("name","name",{unique:!1}),s.createIndex("parentId","parentId",{unique:!1}),s.createIndex("order","order",{unique:!1}),s.createIndex("createdAt","createdAt",{unique:!1}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} folders \uC800\uC7A5\uC18C \uC0DD\uC131\uB428")}if(!e.objectStoreNames.contains("recentFiles")){let s=e.createObjectStore("recentFiles",{keyPath:"id"});s.createIndex("documentId","documentId",{unique:!1}),s.createIndex("viewedAt","viewedAt",{unique:!1}),s.createIndex("createdAt","createdAt",{unique:!1}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} recentFiles \uC800\uC7A5\uC18C \uC0DD\uC131\uB428")}e.objectStoreNames.contains("settings")||(e.createObjectStore("settings",{keyPath:"key"}),this.debugLogger.info("IndexedDB-Init","\u{1F4E6} settings \uC800\uC7A5\uC18C \uC0DD\uC131\uB428")),e.objectStoreNames.contains("documentsMeta")}migrateToDocumentsMeta(){return u(this,null,function*(){try{let e=yield this.ensureDB();if(!e.objectStoreNames.contains("documentsMeta"))return;if((e.objectStoreNames.contains("settings")?yield this.getSetting("metaMigrationDone"):null)===!0){this.debugLogger.info(this.logCategory,"\u2705 documentsMeta \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC774\uBBF8 \uC644\uB8CC\uB428");return}this.debugLogger.info(this.logCategory,"\u{1F504} documentsMeta \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2DC\uC791...");let s=e.transaction(["documents","documentsMeta"],"readwrite"),g=s.objectStore("documents"),c=s.objectStore("documentsMeta");return new Promise((a,n)=>{let r=g.openCursor(),o=0;r.onsuccess=()=>{let i=r.result;if(i){let d=i.value,l={id:d.id,title:d.title,fileName:d.fileName,thumbnail:d.thumbnail,fileSize:d.fileSize,pageCount:d.pageCount,createdAt:d.createdAt,updatedAt:d.updatedAt,documentType:d.documentType,folderId:d.folderId,isFavorite:d.isFavorite,isEncrypted:d.isEncrypted,mimeType:d.mimeType,version:d.version,elementCount:d.elementCount};c.put(l),o++,i.continue()}else this.debugLogger.success(this.logCategory,`\u2705 documentsMeta \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC644\uB8CC: ${o}\uAC1C \uBB38\uC11C`),this.setSetting("metaMigrationDone",!0),a()},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(e){this.debugLogger.error(this.logCategory,`\u274C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC911 \uC624\uB958: ${e}`)}})}getSetting(e){return u(this,null,function*(){try{let t=yield this.ensureDB();if(!t.objectStoreNames.contains("settings"))return null;let g=t.transaction(["settings"],"readonly").objectStore("settings");return new Promise(c=>{let a=g.get(e);a.onsuccess=()=>c(a.result?.value??null),a.onerror=()=>c(null)})}catch{return null}})}setSetting(e,t){return u(this,null,function*(){try{let s=yield this.ensureDB();if(!s.objectStoreNames.contains("settings"))return;s.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t})}catch{}})}getAppSetting(e,t){return u(this,null,function*(){let s=yield this.getSetting(e);return s!==null?s:t})}setAppSetting(e,t){return u(this,null,function*(){yield this.setSetting(e,t)})}saveDocument(e){return u(this,null,function*(){try{let t=yield this.ensureDB(),s=t.objectStoreNames.contains("documentsMeta")?[this.storeName,"documentsMeta"]:[this.storeName],g=t.transaction(s,"readwrite"),c=g.objectStore(this.storeName);return new Promise((a,n)=>{g.oncomplete=()=>{this.debugLogger.success(this.logCategory,`\u{1F4BE} \uBB38\uC11C \uC800\uC7A5 \uC644\uB8CC: ${e.title}`),a()},g.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD2B8\uB79C\uC7AD\uC158 \uC624\uB958: ${g.error}`),n(g.error)};let r=c.get(e.id);r.onsuccess=()=>{let o=r.result;if(o)e.createdAt=o.createdAt,e.updatedAt=new Date().toISOString();else{let i=new Date().toISOString();e.createdAt=i,e.updatedAt=i}if(c.put(e),t.objectStoreNames.contains("documentsMeta")){let i=g.objectStore("documentsMeta"),d={id:e.id,title:e.title,fileName:e.fileName,thumbnail:e.thumbnail,fileSize:e.fileSize,pageCount:e.pageCount,createdAt:e.createdAt,updatedAt:e.updatedAt,documentType:e.documentType,folderId:e.folderId,isFavorite:e.isFavorite,isEncrypted:e.isEncrypted,mimeType:e.mimeType,version:e.version,elementCount:e.elementCount};i.put(d)}},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uAE30\uC874 \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC800\uC7A5 \uC911 \uC624\uB958: ${t}`),t}})}getAllDocuments(){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName).index("updatedAt");return new Promise((c,a)=>{let n=g.openCursor(null,"prev"),r=[];n.onsuccess=()=>{let o=n.result;o?(r.push(o.value),o.continue()):(this.debugLogger.info(this.logCategory,`\u{1F4C4} \uBB38\uC11C \uBAA9\uB85D \uC870\uD68C \uC644\uB8CC: ${r.length}\uAC1C`),c(r))},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBAA9\uB85D \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBAA9\uB85D \uC870\uD68C \uC911 \uC624\uB958: ${e}`),[]}})}getAllDocumentsMetadataOnly(){return u(this,null,function*(){try{let e=yield this.ensureDB();if(e.objectStoreNames.contains("documentsMeta")){let n=e.transaction(["documentsMeta"],"readonly").objectStore("documentsMeta").index("updatedAt");return new Promise((r,o)=>{let i=n.getAll();i.onsuccess=()=>{let d=i.result;d.sort((l,h)=>new Date(h.updatedAt).getTime()-new Date(l.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u{1F4C4} \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC644\uB8CC: ${d.length}\uAC1C (documentsMeta \uC800\uC7A5\uC18C)`),r(d)},i.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${i.error}`),o(i.error)}})}let g=e.transaction([this.storeName],"readonly").objectStore(this.storeName).index("updatedAt");return new Promise((c,a)=>{let n=g.openCursor(null,"prev"),r=[];n.onsuccess=()=>{let o=n.result;if(o){let i=o.value;r.push({id:i.id,title:i.title,fileName:i.fileName,thumbnail:i.thumbnail,fileSize:i.fileSize,pageCount:i.pageCount,createdAt:i.createdAt,updatedAt:i.updatedAt,documentType:i.documentType,folderId:i.folderId,isFavorite:i.isFavorite,isEncrypted:i.isEncrypted,mimeType:i.mimeType,version:i.version,elementCount:i.elementCount}),o.continue()}else this.debugLogger.info(this.logCategory,`\u{1F4C4} \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC644\uB8CC: ${r.length}\uAC1C (fallback)`),c(r)},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC911 \uC624\uB958: ${e}`),[]}})}getFolderContentsMetadataOnly(e){return u(this,null,function*(){try{let t=yield this.ensureDB();if(t.objectStoreNames.contains("documentsMeta")){let a=t.transaction(["documentsMeta"],"readonly").objectStore("documentsMeta");return new Promise((n,r)=>{let o=a.getAll();o.onsuccess=()=>{let i=o.result;i=i.filter(d=>e===null?!d.folderId||d.folderId===null:d.folderId===e),i.sort((d,l)=>new Date(l.updatedAt).getTime()-new Date(d.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u{1F4C4} \uD3F4\uB354 \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC644\uB8CC: ${i.length}\uAC1C (documentsMeta \uC800\uC7A5\uC18C)`),n(i)},o.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${o.error}`),r(o.error)}})}let g=t.transaction(["documents"],"readonly").objectStore("documents");return new Promise((c,a)=>{let n=g.openCursor(),r=[];n.onsuccess=()=>{let o=n.result;if(o){let i=o.value;i.folderId===e&&r.push({id:i.id,title:i.title,fileName:i.fileName,thumbnail:i.thumbnail,fileSize:i.fileSize,pageCount:i.pageCount,createdAt:i.createdAt,updatedAt:i.updatedAt,documentType:i.documentType,folderId:i.folderId,isFavorite:i.isFavorite,isEncrypted:i.isEncrypted,mimeType:i.mimeType,version:i.version,elementCount:i.elementCount}),o.continue()}else r.sort((i,d)=>new Date(d.updatedAt).getTime()-new Date(i.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u{1F4C4} \uD3F4\uB354 \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC644\uB8CC: ${r.length}\uAC1C (fallback)`),c(r)},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),[]}})}updateDocumentThumbnail(e,t){return u(this,null,function*(){try{let s=yield this.ensureDB(),g=s.objectStoreNames.contains("documentsMeta")?[this.storeName,"documentsMeta"]:[this.storeName],c=s.transaction(g,"readwrite"),a=c.objectStore(this.storeName);return new Promise((n,r)=>{let o=a.get(e);o.onsuccess=()=>{let i=o.result;if(!i){r(new Error("\uBB38\uC11C\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."));return}i.thumbnail=t;let d=a.put(i);d.onsuccess=()=>{if(s.objectStoreNames.contains("documentsMeta")){let l=c.objectStore("documentsMeta"),h=l.get(e);h.onsuccess=()=>{let m=h.result;m&&(m.thumbnail=t,l.put(m)),this.debugLogger.success(this.logCategory,`\u{1F5BC}\uFE0F \uC378\uB124\uC77C \uC5C5\uB370\uC774\uD2B8 \uC644\uB8CC: ${e}`),n()},h.onerror=()=>{this.debugLogger.warn(this.logCategory,"\u26A0\uFE0F documentsMeta \uC378\uB124\uC77C \uC5C5\uB370\uC774\uD2B8 \uC2E4\uD328"),n()}}else this.debugLogger.success(this.logCategory,`\u{1F5BC}\uFE0F \uC378\uB124\uC77C \uC5C5\uB370\uC774\uD2B8 \uC644\uB8CC: ${e}`),n()},d.onerror=()=>r(d.error)},o.onerror=()=>r(o.error)})}catch(s){throw this.debugLogger.error(this.logCategory,`\u274C \uC378\uB124\uC77C \uC5C5\uB370\uC774\uD2B8 \uC911 \uC624\uB958: ${s}`),s}})}getDocumentPdfData(e){return u(this,null,function*(){try{return(yield this.getById(e))?.pdfBase64||null}catch(t){return this.debugLogger.error(this.logCategory,`\u274C PDF \uB370\uC774\uD130 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),null}})}getDocumentById(e){return u(this,null,function*(){try{return yield this.getById(e)}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC911 \uC624\uB958: ${t}`),null}})}getDocumentMetadataById(e){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((c,a)=>{let n=g.get(e);n.onsuccess=()=>{let r=n.result;if(!r){c(null);return}c({id:r.id,title:r.title,fileName:r.fileName,thumbnail:r.thumbnail,fileSize:r.fileSize,pageCount:r.pageCount,createdAt:r.createdAt,updatedAt:r.updatedAt,documentType:r.documentType,folderId:r.folderId,isFavorite:r.isFavorite,isEncrypted:r.isEncrypted,mimeType:r.mimeType,version:r.version,elementCount:r.elementCount})},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),null}})}getDocumentByTitle(e){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName).index("title");return new Promise((a,n)=>{let r=c.get(e);r.onsuccess=()=>{a(r.result||null)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC911 \uC624\uB958: ${t}`),null}})}findDocumentMetadataByFileNameAndType(e,t){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName);return new Promise((a,n)=>{let r=c.openCursor();r.onsuccess=()=>{let o=r.result;if(o){let i=o.value;if(i.fileName===e&&i.documentType===t){a({id:i.id,title:i.title,fileName:i.fileName,documentType:i.documentType,createdAt:i.createdAt,updatedAt:i.updatedAt});return}o.continue()}else a(null)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(s){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC911 \uC624\uB958: ${s}`),null}})}updateDocument(e){return u(this,null,function*(){try{e.updatedAt=new Date().toISOString();let t=yield this.ensureDB(),g=t.transaction([this.storeName],"readwrite").objectStore(this.storeName);if(yield new Promise((c,a)=>{let n=g.put(e);n.onsuccess=()=>{this.debugLogger.success(this.logCategory,`\u270F\uFE0F \uBB38\uC11C \uC5C5\uB370\uC774\uD2B8 \uC644\uB8CC: ${e.title}`),c()},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC5C5\uB370\uC774\uD2B8 \uC2E4\uD328: ${n.error}`),a(n.error)}}),t.objectStoreNames.contains("documentsMeta")){let a=t.transaction(["documentsMeta"],"readwrite").objectStore("documentsMeta");yield new Promise((n,r)=>{let o=a.get(e.id);o.onsuccess=()=>{let i=o.result;if(i){i.title=e.title,i.fileName=e.fileName,i.updatedAt=e.updatedAt;let d=a.put(i);d.onsuccess=()=>{this.debugLogger.success(this.logCategory,`\u270F\uFE0F \uBA54\uD0C0\uB370\uC774\uD130 \uC5C5\uB370\uC774\uD2B8 \uC644\uB8CC: ${e.title}`),n()},d.onerror=()=>{this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uBA54\uD0C0\uB370\uC774\uD130 \uC5C5\uB370\uC774\uD2B8 \uC2E4\uD328 (\uBB34\uC2DC\uB428): ${d.error}`),n()}}else this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uBA54\uD0C0\uB370\uC774\uD130 \uC5C6\uC74C (\uBB34\uC2DC\uB428): ${e.id}`),n()},o.onerror=()=>{this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uBA54\uD0C0\uB370\uC774\uD130 \uC870\uD68C \uC2E4\uD328 (\uBB34\uC2DC\uB428): ${o.error}`),n()}})}}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC5C5\uB370\uC774\uD2B8 \uC911 \uC624\uB958: ${t}`),t}})}deleteDocument(e){return u(this,null,function*(){try{yield this.delete(e);try{let t=yield this.ensureDB();t.objectStoreNames.contains("documentsMeta")&&t.transaction(["documentsMeta"],"readwrite").objectStore("documentsMeta").delete(e)}catch(t){this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uBA54\uD0C0\uB370\uC774\uD130 \uC0AD\uC81C \uC2E4\uD328 (\uBB34\uC2DC\uB428): ${t}`)}try{(yield this.ensureDB()).objectStoreNames.contains("recentFiles")&&(yield this.removeFromRecentFilesByDocumentId(e))}catch(t){this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uCD5C\uADFC \uD30C\uC77C \uBAA9\uB85D \uC0AD\uC81C \uC2E4\uD328 (\uBB34\uC2DC\uB428): ${t}`)}this.debugLogger.success(this.logCategory,`\u{1F5D1}\uFE0F \uBB38\uC11C \uC0AD\uC81C \uC131\uACF5: ${e}`)}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC0AD\uC81C \uC911 \uC624\uB958: ${t}`),t}})}searchDocumentsByTitle(e){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction([this.storeName],"readonly").objectStore(this.storeName).index("title");return new Promise((a,n)=>{let r=c.openCursor(IDBKeyRange.bound(e,e+"\uFFFF")),o=[];r.onsuccess=()=>{let i=r.result;i?(i.value.title.toLowerCase().includes(e.toLowerCase())&&o.push(i.value),i.continue()):a(o)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uAC80\uC0C9 \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uAC80\uC0C9 \uC911 \uC624\uB958: ${t}`),[]}})}getRecentDocuments(e=30){return u(this,null,function*(){try{return(yield this.getAllDocuments()).slice(0,e)}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uCD5C\uADFC \uBB38\uC11C \uC870\uD68C \uC911 \uC624\uB958: ${t}`),[]}})}getStorageUsage(){return u(this,null,function*(){try{if("storage"in navigator&&"estimate"in navigator.storage){let e=yield navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}return{used:0,quota:0}}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uC2A4\uD1A0\uB9AC\uC9C0 \uC0AC\uC6A9\uB7C9 \uD655\uC778 \uC2E4\uD328: ${e}`),{used:0,quota:0}}})}cleanupOldDocuments(e=20){return u(this,null,function*(){try{let t=yield this.getAllDocuments();if(t.length>e){let s=t.slice(e);for(let g of s)yield this.deleteDocument(g.id);this.debugLogger.info(this.logCategory,`\u{1F9F9} \uC624\uB798\uB41C \uBB38\uC11C ${s.length}\uAC1C \uC0AD\uC81C \uC644\uB8CC`)}}catch(t){this.debugLogger.error(this.logCategory,`\u274C \uB370\uC774\uD130\uBCA0\uC774\uC2A4 \uC815\uB9AC \uC911 \uC624\uB958: ${t}`)}})}migrateFromLocalStorage(){return u(this,null,function*(){try{let e=localStorage.getItem("savedDocuments");if(e){let t=JSON.parse(e);this.debugLogger.info("IndexedDB-Migration",`\u{1F504} \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2DC\uC791: ${t.length}\uAC1C \uBB38\uC11C`);let s=0,g=0,c=5;for(let a=0;a<t.length;a+=c){let n=t.slice(a,a+c);for(let r of n)try{yield this.saveDocument(r),s++,this.debugLogger.success("IndexedDB-Migration",`\u2705 \uBB38\uC11C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC131\uACF5: ${r.title} (${s}/${t.length})`)}catch(o){g++,this.debugLogger.error("IndexedDB-Migration",`\u274C \uAC1C\uBCC4 \uBB38\uC11C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC2E4\uD328: ${r.title} - ${o}`)}a+c<t.length&&(yield new Promise(r=>setTimeout(r,10)))}this.debugLogger.info("IndexedDB-Migration",`\u{1F4CA} \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC644\uB8CC: \uC131\uACF5 ${s}\uAC1C, \uC2E4\uD328 ${g}\uAC1C`),s>0&&(localStorage.removeItem("savedDocuments"),this.debugLogger.info("IndexedDB-Migration","\u{1F9F9} localStorage \uC815\uB9AC \uC644\uB8CC"))}else this.debugLogger.info("IndexedDB-Migration","\u2139\uFE0F \uB9C8\uC774\uADF8\uB808\uC774\uC158\uD560 localStorage \uB370\uC774\uD130 \uC5C6\uC74C")}catch(e){throw this.debugLogger.error("IndexedDB-Migration",`\u274C \uB9C8\uC774\uADF8\uB808\uC774\uC158 \uC911 \uC624\uB958: ${e}`),e}})}createFolder(e,t=null){return u(this,null,function*(){try{let s=yield this.ensureDB(),g=yield this.getFolders(t);this.debugLogger.info(this.logCategory,`\u{1F4CA} \uAE30\uC874 \uD3F4\uB354 \uAC1C\uC218: ${g.length}`);let c=g.length>0?Math.max(...g.map(o=>o.order)):0,a={id:this.generateId(),name:e,parentId:t,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),order:c+1},r=s.transaction(["folders"],"readwrite").objectStore("folders");return new Promise((o,i)=>{let d=r.add(a);d.onsuccess=()=>u(this,null,function*(){this.debugLogger.success(this.logCategory,`\u2705 \uD3F4\uB354 \uC800\uC7A5 \uC644\uB8CC: ${e}, id: ${a.id}`);let l=r.get(a.id);l.onsuccess=()=>{},o(a)}),d.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC0DD\uC131 \uC2E4\uD328: ${d.error}`),i(d.error)}})}catch(s){throw this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC0DD\uC131 \uC911 \uC624\uB958: ${s}`),s}})}updateFolder(e,t){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction(["folders"],"readwrite").objectStore("folders");return new Promise((a,n)=>{let r=c.get(e);r.onsuccess=()=>{let o=r.result;if(!o){n(new Error("\uD3F4\uB354\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."));return}o.name=t,o.updatedAt=new Date().toISOString();let i=c.put(o);i.onsuccess=()=>{this.debugLogger.success(this.logCategory,`\u{1F4DD} \uD3F4\uB354 \uC218\uC815 \uC644\uB8CC: ${t}`),a()},i.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC218\uC815 \uC2E4\uD328: ${i.error}`),n(i.error)}},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(s){throw this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC218\uC815 \uC911 \uC624\uB958: ${s}`),s}})}deleteFolder(e){return u(this,null,function*(){try{let s=(yield this.ensureDB()).transaction(["folders","documents"],"readwrite"),g=s.objectStore("folders"),c=s.objectStore("documents");return new Promise((a,n)=>{s.oncomplete=()=>{this.debugLogger.success(this.logCategory,`\u{1F5D1}\uFE0F \uD3F4\uB354 \uC0AD\uC81C \uC644\uB8CC: ${e}`),a()},s.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC0AD\uC81C \uD2B8\uB79C\uC7AD\uC158 \uC624\uB958: ${s.error}`),n(s.error)};let r=c.getAll();r.onsuccess=()=>{r.result.filter(d=>d.folderId===e).forEach(d=>{d.folderId=null,d.updatedAt=new Date().toISOString(),c.put(d)}),g.delete(e)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC624\uB958: ${r.error}`),n(r.error)}})}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC0AD\uC81C \uC911 \uC624\uB958: ${t}`),t}})}getFolders(e=null){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction(["folders"],"readonly").objectStore("folders");return new Promise((c,a)=>{let n=g.getAll();n.onsuccess=()=>{let o=n.result.filter(i=>i.parentId===e);o.sort((i,d)=>i.order-d.order),this.debugLogger.info(this.logCategory,`\u{1F4C2} \uD544\uD130\uB9C1\uB41C \uD3F4\uB354 (parentId=${e}): ${o.length}\uAC1C`),c(o)},n.onerror=()=>{console.error("\u{1F534} \uD3F4\uB354 \uC870\uD68C \uC2E4\uD328:",n.error),this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBAA9\uB85D \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){return console.error("\u{1F534} getFolders \uC624\uB958:",t),this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBAA9\uB85D \uC870\uD68C \uC911 \uC624\uB958: ${t}`),[]}})}getFolderById(e){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction(["folders"],"readonly").objectStore("folders");return new Promise((c,a)=>{let n=g.get(e);n.onsuccess=()=>{c(n.result||null)},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),null}})}moveDocumentToFolder(e,t){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction(["documents","documentsMeta"],"readwrite"),c=g.objectStore("documents"),a=g.objectStore("documentsMeta");return new Promise((n,r)=>{let o=c.get(e);o.onsuccess=()=>{let i=o.result;if(!i){r(new Error("\uBB38\uC11C\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."));return}let d=new Date().toISOString();i.folderId=t,i.updatedAt=d;let l=c.put(i);l.onsuccess=()=>{let h=a.get(e);h.onsuccess=()=>{let m=h.result;m&&(m.folderId=t,m.updatedAt=d,a.put(m)),this.debugLogger.success(this.logCategory,`\u{1F4E6} \uBB38\uC11C \uC774\uB3D9 \uC644\uB8CC: ${i.title}`),n()},h.onerror=()=>{this.debugLogger.warn(this.logCategory,"\u26A0\uFE0F documentsMeta \uC5C5\uB370\uC774\uD2B8 \uC2E4\uD328"),n()}},l.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC774\uB3D9 \uC2E4\uD328: ${l.error}`),r(l.error)}},o.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${o.error}`),r(o.error)}})}catch(s){throw this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC774\uB3D9 \uC911 \uC624\uB958: ${s}`),s}})}getFolderContents(e){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction(["documents"],"readonly").objectStore("documents");return new Promise((c,a)=>{let n=g.getAll();n.onsuccess=()=>{let r=n.result,o=r.filter(i=>i.folderId===e);o.sort((i,d)=>new Date(d.updatedAt).getTime()-new Date(i.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u{1F4C4} \uD3F4\uB354 \uB0B4\uC6A9 \uC870\uD68C \uC644\uB8CC: ${o.length}\uAC1C (\uC804\uCCB4: ${r.length}\uAC1C)`),c(o)},n.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uB0B4\uC6A9 \uC870\uD68C \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uB0B4\uC6A9 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),[]}})}getFolderDocumentCount(e){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction(["documents"],"readonly").objectStore("documents").index("folderId");return new Promise((a,n)=>{let r=c.count(e);r.onsuccess=()=>{this.debugLogger.info(this.logCategory,`\u{1F4CA} \uD3F4\uB354 \uBB38\uC11C \uAC1C\uC218: ${r.result}\uAC1C (Index count \uCD5C\uC801\uD654)`),a(r.result)},r.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBB38\uC11C \uAC1C\uC218 \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uBB38\uC11C \uAC1C\uC218 \uC870\uD68C \uC911 \uC624\uB958: ${t}`),0}})}toggleFavoriteFast(e){return u(this,null,function*(){try{let t=yield this.ensureDB();if(t.objectStoreNames.contains("documentsMeta")){let g=t.transaction(["documentsMeta"],"readwrite").objectStore("documentsMeta"),c=yield new Promise((a,n)=>{let r=g.get(e);r.onsuccess=()=>{let o=r.result;if(o){let i=!o.isFavorite;o.isFavorite=i,o.updatedAt=new Date().toISOString();let d=g.put(o);d.onsuccess=()=>a(i),d.onerror=()=>n(d.error)}else n(new Error("\uBA54\uD0C0\uB370\uC774\uD130\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."))},r.onerror=()=>n(r.error)});return this.updateDocumentFavoriteInBackground(e,c),this.debugLogger.success(this.logCategory,`\u2B50 \uC990\uACA8\uCC3E\uAE30 \uBE60\uB978 \uD1A0\uAE00: ${c?"\uCD94\uAC00":"\uC81C\uAC70"}`),c}else return yield this.toggleFavorite(e),!0}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C \uC990\uACA8\uCC3E\uAE30 \uBE60\uB978 \uD1A0\uAE00 \uC2E4\uD328: ${t}`),t}})}updateDocumentFavoriteInBackground(e,t){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction(["documents"],"readwrite").objectStore("documents"),a=c.get(e);a.onsuccess=()=>{let n=a.result;n&&(n.isFavorite=t,n.updatedAt=new Date().toISOString(),c.put(n))}}catch(s){this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F \uBC31\uADF8\uB77C\uC6B4\uB4DC \uC990\uACA8\uCC3E\uAE30 \uB3D9\uAE30\uD654 \uC2E4\uD328: ${s}`)}})}toggleFavorite(e){return u(this,null,function*(){console.log("\u{1F516} [IndexedDB] toggleFavorite \uC2DC\uC791"),console.log("\u{1F516} [IndexedDB] documentId:",e);try{let t=yield this.ensureDB();console.log("\u{1F516} [IndexedDB] DB \uC5F0\uACB0 \uC131\uACF5");let s=t.objectStoreNames.contains("documentsMeta")?["documents","documentsMeta"]:["documents"];console.log("\u{1F516} [IndexedDB] \uC0AC\uC6A9\uD560 \uC800\uC7A5\uC18C:",s);let g=t.transaction(s,"readwrite"),c=g.objectStore("documents");return new Promise((a,n)=>{let r=c.get(e);console.log("\u{1F516} [IndexedDB] \uBB38\uC11C \uC870\uD68C \uC694\uCCAD..."),r.onsuccess=()=>{let o=r.result;if(console.log("\u{1F516} [IndexedDB] \uBB38\uC11C \uC870\uD68C \uACB0\uACFC:",o?{id:o.id,isFavorite:o.isFavorite,title:o.title}:"null"),!o){console.error("\u274C [IndexedDB] \uBB38\uC11C\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4"),n(new Error("\uBB38\uC11C\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."));return}let i=o.isFavorite;o.isFavorite=!o.isFavorite,o.updatedAt=new Date().toISOString(),console.log("\u{1F516} [IndexedDB] \uC990\uACA8\uCC3E\uAE30 \uBCC0\uACBD:",i,"->",o.isFavorite);let d=c.put(o);if(console.log("\u{1F516} [IndexedDB] documents \uC800\uC7A5 \uC694\uCCAD..."),d.onsuccess=()=>{console.log("\u2705 [IndexedDB] documents \uC800\uC7A5 \uC644\uB8CC")},d.onerror=()=>{console.error("\u274C [IndexedDB] documents \uC800\uC7A5 \uC2E4\uD328:",d.error)},t.objectStoreNames.contains("documentsMeta")){console.log("\u{1F516} [IndexedDB] documentsMeta \uB3D9\uAE30\uD654 \uC2DC\uC791...");let l=g.objectStore("documentsMeta"),h=l.get(e);h.onsuccess=()=>{let m=h.result;if(console.log("\u{1F516} [IndexedDB] meta \uC870\uD68C \uACB0\uACFC:",m?"exists":"null"),m){m.isFavorite=o.isFavorite,m.updatedAt=o.updatedAt;let y=l.put(m);y.onsuccess=()=>{console.log("\u2705 [IndexedDB] documentsMeta \uB3D9\uAE30\uD654 \uC644\uB8CC")},y.onerror=()=>{console.error("\u274C [IndexedDB] documentsMeta \uC800\uC7A5 \uC2E4\uD328:",y.error)}}},h.onerror=()=>{console.error("\u274C [IndexedDB] meta \uC870\uD68C \uC2E4\uD328:",h.error)}}this.debugLogger.success(this.logCategory,`\u2B50 \uC990\uACA8\uCC3E\uAE30 ${o.isFavorite?"\uCD94\uAC00":"\uC81C\uAC70"}: ${o.title}`),g.oncomplete=()=>{console.log("\u2705 [IndexedDB] transaction \uC644\uB8CC"),a()},g.onerror=()=>{console.error("\u274C [IndexedDB] transaction \uC5D0\uB7EC:",g.error),n(g.error)}},r.onerror=()=>{console.error("\u274C [IndexedDB] \uBB38\uC11C \uC870\uD68C \uC2E4\uD328:",r.error),this.debugLogger.error(this.logCategory,`\u274C \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){throw console.error("\u274C [IndexedDB] toggleFavorite \uC608\uC678:",t),console.error("\u274C [IndexedDB] \uC2A4\uD0DD \uD2B8\uB808\uC774\uC2A4:",t instanceof Error?t.stack:"N/A"),this.debugLogger.error(this.logCategory,`\u274C \uC990\uACA8\uCC3E\uAE30 \uD1A0\uAE00 \uC911 \uC624\uB958: ${t}`),t}})}getFavoriteDocuments(){return u(this,null,function*(){console.log("\u{1F516} [IndexedDB] getFavoriteDocuments \uC2DC\uC791");try{let e=yield this.ensureDB();if(console.log("\u{1F516} [IndexedDB] DB \uC5F0\uACB0 \uC131\uACF5"),e.objectStoreNames.contains("documentsMeta")){console.log("\u{1F516} [IndexedDB] documentsMeta \uC800\uC7A5\uC18C \uC0AC\uC6A9");try{let s=e.transaction(["documentsMeta"],"readonly").objectStore("documentsMeta");return new Promise((g,c)=>{let a=s.getAll();a.onsuccess=()=>{let n=a.result;console.log("\u{1F516} [IndexedDB] \uC804\uCCB4 \uBB38\uC11C \uAC1C\uC218:",n.length);let r=n.filter(o=>o.isFavorite===!0);console.log("\u{1F516} [IndexedDB] \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uAC1C\uC218:",r.length),r.sort((o,i)=>new Date(i.updatedAt).getTime()-new Date(o.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u2B50 \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uC870\uD68C \uC644\uB8CC: ${r.length}\uAC1C (documentsMeta \uC800\uC7A5\uC18C)`),g(r)},a.onerror=()=>{console.error("\u274C [IndexedDB] documentsMeta getAll \uC2E4\uD328:",a.error),this.debugLogger.error(this.logCategory,`\u274C \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${a.error}`),this.getFavoriteDocumentsFallback(e).then(g).catch(c)}})}catch(t){return console.error("\u274C [IndexedDB] documentsMeta \uC811\uADFC \uC2E4\uD328:",t),this.debugLogger.warn(this.logCategory,`\u26A0\uFE0F documentsMeta \uC811\uADFC \uC2E4\uD328, fallback \uC0AC\uC6A9: ${t}`),this.getFavoriteDocumentsFallback(e)}}return console.log("\u{1F516} [IndexedDB] documentsMeta \uC5C6\uC74C, fallback \uC0AC\uC6A9"),this.getFavoriteDocumentsFallback(e)}catch(e){return console.error("\u274C [IndexedDB] getFavoriteDocuments \uC5D0\uB7EC:",e),this.debugLogger.error(this.logCategory,`\u274C \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uC870\uD68C \uC911 \uC624\uB958: ${e}`),[]}})}getFavoriteDocumentsFallback(e){return u(this,null,function*(){try{let s=e.transaction(["documents"],"readonly").objectStore("documents");return new Promise((g,c)=>{let a=s.openCursor(),n=[];a.onsuccess=()=>{let r=a.result;if(r){let o=r.value;o.isFavorite===!0&&n.push({id:o.id,title:o.title,fileName:o.fileName,thumbnail:o.thumbnail,fileSize:o.fileSize,pageCount:o.pageCount,createdAt:o.createdAt,updatedAt:o.updatedAt,documentType:o.documentType,folderId:o.folderId,isFavorite:o.isFavorite,isEncrypted:o.isEncrypted,mimeType:o.mimeType,version:o.version,elementCount:o.elementCount}),r.continue()}else n.sort((o,i)=>new Date(i.updatedAt).getTime()-new Date(o.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u2B50 \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uC870\uD68C \uC644\uB8CC: ${n.length}\uAC1C (fallback)`),g(n)},a.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uC990\uACA8\uCC3E\uAE30 \uBB38\uC11C \uC870\uD68C \uC2E4\uD328 (fallback): ${a.error}`),g([])}})}catch(t){return this.debugLogger.error(this.logCategory,`\u274C Fallback \uC990\uACA8\uCC3E\uAE30 \uC870\uD68C \uC2E4\uD328: ${t}`),[]}})}getResultDocuments(){return u(this,null,function*(){try{let s=(yield this.ensureDB()).transaction(["documents"],"readonly").objectStore("documents");return new Promise((g,c)=>{let a=s.openCursor(),n=[];a.onsuccess=()=>{let r=a.result;if(r){let o=r.value;o.folderId==="results"&&n.push({id:o.id,title:o.title,fileName:o.fileName,thumbnail:o.thumbnail,fileSize:o.fileSize,pageCount:o.pageCount,createdAt:o.createdAt,updatedAt:o.updatedAt,documentType:o.documentType,folderId:o.folderId,isFavorite:o.isFavorite,isEncrypted:o.isEncrypted,mimeType:o.mimeType,version:o.version,elementCount:o.elementCount}),r.continue()}else n.sort((o,i)=>new Date(i.updatedAt).getTime()-new Date(o.updatedAt).getTime()),this.debugLogger.info(this.logCategory,`\u{1F4CA} \uACB0\uACFC\uBB3C \uBB38\uC11C \uC870\uD68C \uC644\uB8CC: ${n.length}\uAC1C (Cursor \uBA54\uBAA8\uB9AC \uCD5C\uC801\uD654)`),g(n)},a.onerror=()=>{this.debugLogger.error(this.logCategory,`\u274C \uACB0\uACFC\uBB3C \uBB38\uC11C \uC870\uD68C \uC2E4\uD328: ${a.error}`),c(a.error)}})}catch(e){return this.debugLogger.error(this.logCategory,`\u274C \uACB0\uACFC\uBB3C \uBB38\uC11C \uC870\uD68C \uC911 \uC624\uB958: ${e}`),[]}})}getFolderByNameAndParent(e,t){return u(this,null,function*(){try{return(yield this.getFolders(t)).find(c=>c.name===e)||null}catch(s){return this.debugLogger.error(this.logCategory,`\u274C \uD3F4\uB354 \uAC80\uC0C9 \uC911 \uC624\uB958: ${s}`),null}})}ensureAiFunctionFolder(e){return u(this,null,function*(){try{let t=yield this.getFolderByNameAndParent(e,"results");if(t)return this.debugLogger.info(this.logCategory,`\u{1F4C2} ${e} \uD3F4\uB354 \uC774\uBBF8 \uC874\uC7AC`),t;if(t=yield this.createFolder(e,"results"),!t)throw new Error(`${e} \uD3F4\uB354 \uC0DD\uC131 \uC2E4\uD328`);return this.debugLogger.success(this.logCategory,`\u2705 ${e} \uD3F4\uB354 \uC0DD\uC131 \uC644\uB8CC`),t}catch(t){throw this.debugLogger.error(this.logCategory,`\u274C AI \uD3F4\uB354 \uC0DD\uC131 \uC911 \uC624\uB958: ${t}`),t}})}generateId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}addToRecentFiles(e,t,s,g,c,a,n){return u(this,null,function*(){try{let r=yield this.ensureDB();if(!r.objectStoreNames.contains("recentFiles"))return this.debugLogger.warn("IndexedDB-RecentFiles","\u26A0\uFE0F recentFiles \uC800\uC7A5\uC18C \uC5C6\uC74C - DB \uC7AC\uCD08\uAE30\uD654 \uD544\uC694"),r.close(),this.db=null,yield this.initDB(),this.addToRecentFiles(e,t,s,g,c,a,n);let o=yield this.getRecentFileByDocumentId(e),i=new Date().toISOString(),d=o?S(w({},o),{fileName:t,thumbnail:s,documentType:g,folderId:c,fileSize:a,isEncrypted:n,viewedAt:i}):{id:this.generateId(),documentId:e,fileName:t,thumbnail:s,documentType:g,folderId:c,fileSize:a,isEncrypted:n,viewedAt:i,createdAt:i},h=r.transaction(["recentFiles"],"readwrite").objectStore("recentFiles");return new Promise((m,y)=>{let D=h.put(d);D.onsuccess=()=>{this.debugLogger.success("IndexedDB-RecentFiles",`\u{1F4CC} \uCD5C\uADFC \uBCF8 \uD30C\uC77C\uC5D0 \uCD94\uAC00: ${t}`),m()},D.onerror=()=>{this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uCD94\uAC00 \uC2E4\uD328: ${D.error}`),y(D.error)}})}catch(r){throw this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uCD94\uAC00 \uC911 \uC624\uB958: ${r}`),r}})}getRecentFileByDocumentId(e){return u(this,null,function*(){try{let c=(yield this.ensureDB()).transaction(["recentFiles"],"readonly").objectStore("recentFiles").index("documentId");return new Promise((a,n)=>{let r=c.get(e);r.onsuccess=()=>{a(r.result||null)},r.onerror=()=>{n(r.error)}})}catch{return null}})}getRecentFileEntries(e=30){return u(this,null,function*(){try{let t=yield this.ensureDB();if(!t.objectStoreNames.contains("recentFiles"))return this.debugLogger.warn("IndexedDB-RecentFiles","\u26A0\uFE0F recentFiles \uC800\uC7A5\uC18C \uC5C6\uC74C - \uBE48 \uBAA9\uB85D \uBC18\uD658"),[];let c=t.transaction(["recentFiles"],"readonly").objectStore("recentFiles").index("viewedAt");return new Promise((a,n)=>{let r=c.openCursor(null,"prev"),o=[];r.onsuccess=()=>{let i=r.result;i&&o.length<e?(o.push(i.value),i.continue()):(this.debugLogger.info("IndexedDB-RecentFiles",`\u{1F4CB} \uCD5C\uADFC \uBCF8 \uD30C\uC77C \uC870\uD68C \uC644\uB8CC: ${o.length}\uAC1C`),a(o))},r.onerror=()=>{this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC870\uD68C \uC2E4\uD328: ${r.error}`),n(r.error)}})}catch(t){return this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC870\uD68C \uC911 \uC624\uB958: ${t}`),[]}})}removeFromRecentFiles(e){return u(this,null,function*(){try{let g=(yield this.ensureDB()).transaction(["recentFiles"],"readwrite").objectStore("recentFiles");return new Promise((c,a)=>{let n=g.delete(e);n.onsuccess=()=>{this.debugLogger.success("IndexedDB-RecentFiles","\u{1F5D1}\uFE0F \uCD5C\uADFC \uD30C\uC77C\uC5D0\uC11C \uC81C\uAC70 \uC644\uB8CC"),c()},n.onerror=()=>{this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC81C\uAC70 \uC2E4\uD328: ${n.error}`),a(n.error)}})}catch(t){throw this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC81C\uAC70 \uC911 \uC624\uB958: ${t}`),t}})}removeFromRecentFilesByDocumentId(e){return u(this,null,function*(){try{let t=yield this.getRecentFileByDocumentId(e);t&&(yield this.removeFromRecentFiles(t.id),this.debugLogger.success("IndexedDB-RecentFiles",`\u{1F5D1}\uFE0F documentId\uB85C \uCD5C\uADFC \uD30C\uC77C \uC81C\uAC70 \uC644\uB8CC: ${e}`))}catch(t){throw this.debugLogger.error("IndexedDB-RecentFiles",`\u274C documentId\uB85C \uCD5C\uADFC \uD30C\uC77C \uC81C\uAC70 \uC911 \uC624\uB958: ${t}`),t}})}clearRecentFiles(){return u(this,null,function*(){try{let s=(yield this.ensureDB()).transaction(["recentFiles"],"readwrite").objectStore("recentFiles");return new Promise((g,c)=>{let a=s.clear();a.onsuccess=()=>{this.debugLogger.success("IndexedDB-RecentFiles","\u{1F5D1}\uFE0F \uCD5C\uADFC \uD30C\uC77C \uC804\uCCB4 \uC0AD\uC81C \uC644\uB8CC"),g()},a.onerror=()=>{this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC804\uCCB4 \uC0AD\uC81C \uC2E4\uD328: ${a.error}`),c(a.error)}})}catch(e){throw this.debugLogger.error("IndexedDB-RecentFiles",`\u274C \uCD5C\uADFC \uD30C\uC77C \uC804\uCCB4 \uC0AD\uC81C \uC911 \uC624\uB958: ${e}`),e}})}static \u0275fac=function(t){return new(t||b)};static \u0275prov=f({token:b,factory:b.\u0275fac,providedIn:"root"})};export{p as a,I as b};
